<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Math Drop Game</title>
  <style>
    :root{
      --ui-glass: rgba(255,255,255,0.95);
      --brand-1: #FFB347;
      --brand-2: #FF6B9D;
      --accent-1: #4ECDC4;
      --accent-2: #45B7D1;
      --success: #95E1D3;
      --warning: #F38181;
      --purple: #AA96DA;
      --yellow: #FFE66D;
      --green: #06D6A0;
      --blue: #118AB2;
      --pink: #EF476F;
    }

    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, var(--brand-1) 0%, var(--brand-2) 100%);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
      overflow: hidden;
      height: 100vh;
      -webkit-font-smoothing: antialiased;
    }
    
    .screen { 
      display: none;
    }
    .screen.active { 
      display: block;
      position: relative;
      width: 100vw;
      height: 100vh;
    }

    .home-screen {
      background: linear-gradient(135deg, var(--brand-1) 0%, var(--brand-2) 100%);
      padding: 20px;
    }

    .home-screen.active {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .game-title {
      font-size: 48px;
      font-weight: bold;
      color: white;
      text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
      margin-bottom: 20px;
      text-align: center;
    }
    .subhead {
      color: #fff;
      margin-bottom: 24px;
      opacity: 0.9;
      font-weight: bold;
      font-size: 18px;
    }
    .categories-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      max-width: 1200px;
      width: 100%;
      padding: 0 20px;
    }
    .category-card {
      background: rgba(255,255,255,0.95);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
      border: 4px solid transparent;
    }
    .category-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 35px rgba(0,0,0,0.3);
      border-color: var(--accent-1);
    }
    .category-title {
      font-size: 26px;
      font-weight: bold;
      color: #2D3748;
      margin-bottom: 15px;
      text-align: center;
    }
    .level-button {
      display: block;
      width: 100%;
      background: linear-gradient(145deg, var(--accent-1) 0%, var(--accent-2) 100%);
      color: white;
      border: none;
      padding: 14px 20px;
      margin: 10px 0;
      font-size: 18px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s ease;
      font-family: inherit;
      touch-action: manipulation;
      -webkit-tap-highlight-color: rgba(0,0,0,0.1);
      user-select: none;
      -webkit-user-select: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .level-button:active {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.25);
    }
    .level-button.tables { background: linear-gradient(145deg, var(--purple) 0%, #9B7EDE 100%); }
    .level-button.subtraction { background: linear-gradient(145deg, var(--pink) 0%, #E63E6D 100%); }
    .level-button.diff { background: linear-gradient(145deg, var(--yellow) 0%, #FFD93D 100%); color: #2D3748; }
    .level-button.selected { 
      outline: 4px solid #fff; 
      box-shadow: 0 0 0 6px rgba(0,0,0,0.15), 0 6px 20px rgba(0,0,0,0.25); 
      transform: scale(1.05);
    }

    .leaderboard-open {
      background: linear-gradient(145deg, var(--green) 0%, #05C494 100%);
      cursor: pointer;
      touch-action: manipulation;
    }

    .game-container {
      position: relative; 
      width: 100vw; 
      height: 100vh;
      background: linear-gradient(135deg, #FFE5B4 0%, #FFB6C1 50%, #E0BBE4 100%);
    }
    
    .ui-panel {
      position: fixed; top: 0; left: 0; right: 0;
      background: rgba(255,255,255,0.98);
      padding: 12px 15px;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      z-index: 1000;
      border-bottom: 4px solid var(--accent-1);
    }
    .ui-left { display:flex; align-items:center; gap:16px; flex-wrap: wrap; }
    .score { font-size: 24px; font-weight: bold; color: var(--pink); }
    .high-score { font-size: 16px; color: var(--purple); font-weight: bold; }
    .diff-pill {
      padding: 6px 12px; border-radius: 999px; background: var(--yellow); color: #2D3748;
      font-size: 14px; font-weight: 700; border: 2px solid #FFD93D;
    }
    .question-counter { font-size: 20px; color: var(--blue); text-align:center; font-weight: bold; }
    .ui-right { display:flex; gap:8px; align-items:center; justify-content:flex-end; }
    .home-button, .mute-button, .lb-button {
      background: linear-gradient(145deg, var(--blue) 0%, #0F7A9D 100%);
      color: white; border: none; padding: 10px 16px; border-radius: 10px;
      cursor: pointer; font-weight: bold; font-family: inherit;
      touch-action: manipulation; box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    }
    .current-topic { font-size: 20px; color: var(--pink); font-weight: bold; text-align:center; }

    .lives { display:flex; align-items:center; gap:6px; margin-left: 6px; font-size: 26px; }
    .heart { filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
    .heart.lost { opacity: 0.2; }

    .timer-wrap {
      position: fixed; top: 68px; left: 50%; transform: translateX(-50%);
      width: min(720px, 90vw); height: 12px; background: rgba(255,255,255,0.6);
      border-radius: 999px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      z-index: 999; border: 2px solid white;
    }
    .timer-bar { 
      height: 100%; width: 100%; 
      background: linear-gradient(90deg, var(--green), var(--yellow), var(--warning));
      transform-origin: left center; 
    }

    .math-problem {
      position: absolute;
      background: linear-gradient(145deg, #FFDEE9 0%, #B5FFFC 100%);
      color: #2D3748; 
      padding: 15px 20px; 
      border-radius: 20px;
      font-size: 32px; 
      font-weight: bold;
      box-shadow: 0 8px 25px rgba(0,0,0,0.25);
      transition: all 0.2s ease;
      min-width: 200px; 
      text-align: center;
      border: 5px solid white; 
      z-index: 10;
    }

    .answer-display {
      background: white; 
      border: 4px solid var(--accent-1); 
      border-radius: 12px;
      padding: 8px; 
      font-size: 28px; 
      text-align: center; 
      margin-top: 8px;
      min-width: 80px; 
      font-weight: bold;
      color: #2D3748;
      min-height: 40px;
      line-height: 40px;
      font-family: 'Comic Sans MS', cursive, sans-serif;
    }

    /* Number pad at bottom */
    .number-pad {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.98);
      padding: 15px;
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
      z-index: 1001;
      border-top: 4px solid var(--accent-1);
      max-width: 600px;
      margin: 0 auto;
    }
    
    .num-btn {
      background: linear-gradient(145deg, var(--accent-1) 0%, var(--accent-2) 100%);
      color: white;
      border: none;
      padding: 20px;
      font-size: 28px;
      font-weight: bold;
      border-radius: 15px;
      cursor: pointer;
      font-family: inherit;
      touch-action: manipulation;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      transition: all 0.1s ease;
    }
    
    .num-btn:active {
      transform: scale(0.95);
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    
    .num-btn.clear {
      background: linear-gradient(145deg, var(--warning) 0%, #E76B6B 100%);
      grid-column: span 2;
    }
    
    .num-btn.zero {
      grid-column: span 2;
    }

    .game-over-screen {
      position: fixed; inset: 0; background: rgba(0,0,0,0.85);
      display: none; justify-content: center; align-items: center; z-index: 2000;
    }
    .game-over-content {
      background: linear-gradient(145deg, var(--brand-1) 0%, var(--brand-2) 100%);
      color: white; padding: 40px; border-radius: 25px; text-align: center;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5); max-width: 90vw;
      border: 5px solid white;
    }
    .game-over-content h2 { margin-top: 0; font-size: 42px; text-shadow: 3px 3px 6px rgba(0,0,0,0.3); }
    .final-score { font-size: 32px; margin: 15px 0; font-weight: bold; }
    .game-over-buttons { display:flex; gap:15px; justify-content:center; margin-top:20px; flex-wrap: wrap; }
    .play-again-btn, .home-btn {
      background: linear-gradient(145deg, var(--green) 0%, #05C494 100%);
      color: white; border:none; padding: 15px 25px; font-size: 20px; border-radius: 12px;
      cursor: pointer; font-weight: bold; transition: all 0.2s ease; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      font-family: inherit; touch-action: manipulation;
    }
    .home-btn { background: linear-gradient(145deg, var(--blue) 0%, #0F7A9D 100%); }
    .save-btn { 
      background: linear-gradient(145deg, var(--purple) 0%, #9B7EDE 100%); 
      color:#fff; border:none; padding: 15px 25px; font-size: 20px; 
      border-radius: 12px; cursor: pointer; font-weight: bold; touch-action: manipulation;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    .name-wrap { margin-top: 15px; }
    .name-input {
      padding: 12px 15px; border-radius: 12px; border: 3px solid white; width: 250px; 
      font-size: 18px; box-shadow: 0 0 0 3px rgba(255,255,255,0.3) inset;
      font-family: 'Comic Sans MS', cursive, sans-serif;
    }
    .hint { font-size: 16px; opacity: 0.95; margin-top: 10px; font-weight: bold; }

    .modal {
      position: fixed; inset: 0; display:none; align-items: center; justify-content:center; 
      background: rgba(0,0,0,0.75); z-index: 2500;
    }
    .modal.active { display:flex; }
    .modal-card {
      background: #ffffff;
      color:#2d3748;
      width: min(860px, 92vw);
      border-radius: 20px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.4);
      overflow: hidden;
      border: 5px solid var(--accent-1);
    }
    .modal-head {
      display:flex; justify-content: space-between; align-items:center;
      padding: 15px 20px; 
      background: linear-gradient(145deg, var(--brand-1), var(--brand-2)); 
      color:#fff;
    }
    .modal-body { padding: 20px; background: #F7FAFC; }
    .close-btn { 
      background: transparent; color:#fff; border:none; font-size: 28px; 
      cursor: pointer; touch-action: manipulation; font-weight: bold;
    }
    .filters { display:flex; gap: 10px; flex-wrap: wrap; align-items:center; margin-bottom: 15px; }
    select, .filter-pill {
      padding: 8px 12px; border-radius: 10px; border: 2px solid #e2e8f0; 
      background:#fff; font-weight:700; font-size: 16px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
    }
    .filter-pill { background: var(--yellow); color: #2D3748; border-color: #FFD93D; }
    table { 
      width:100%; border-collapse: collapse; background: #fff; 
      border-radius: 12px; overflow: hidden; 
    }
    th, td { padding: 12px 15px; border-bottom: 2px solid #edf2f7; text-align:left; font-size: 16px; }
    thead tr { background: var(--accent-1); color: white; font-weight: bold; }
    tbody tr:nth-child(even){ background:#F0F9FF; }
    tbody tr:hover { background: #E0F2FE; }
    .empty { padding: 25px; text-align:center; color:#718096; font-weight:700; font-size: 18px; }

    @media (max-width: 768px) {
      .game-title { font-size: 36px; }
      .categories-grid { grid-template-columns: 1fr; max-width: 400px; }
      .num-btn { padding: 15px; font-size: 24px; }
    }
  </style>
</head>
<body>

  <div class="screen active home-screen" id="home-screen">
    <div class="game-title">🎯 Math Drop Challenge! 🎯</div>
    <div class="subhead">Pick a topic, set difficulty, and try to make the leaderboard!</div>

    <div class="categories-grid">
      <div class="category-card">
        <div class="category-title">➕ Addition Practice</div>
        <button class="level-button" data-game="addition" data-level="20">Addition up to 20</button>
        <button class="level-button" data-game="addition" data-level="30">Addition up to 30</button>
        <button class="level-button" data-game="addition" data-level="40">Addition up to 40</button>
        <button class="level-button" data-game="addition" data-level="50">Addition up to 50</button>
      </div>

      <div class="category-card">
        <div class="category-title">✖️ Times Tables</div>
        <button class="level-button tables" data-game="tables" data-level="2">2 Times Table</button>
        <button class="level-button tables" data-game="tables" data-level="3">3 Times Table</button>
        <button class="level-button tables" data-game="tables" data-level="4">4 Times Table</button>
        <button class="level-button tables" data-game="tables" data-level="5">5 Times Table</button>
      </div>

      <div class="category-card">
        <div class="category-title">✖️ More Times Tables</div>
        <button class="level-button tables" data-game="tables" data-level="6">6 Times Table</button>
        <button class="level-button tables" data-game="tables" data-level="7">7 Times Table</button>
        <button class="level-button tables" data-game="tables" data-level="8">8 Times Table</button>
        <button class="level-button tables" data-game="tables" data-level="9">9 Times Table</button>
        <button class="level-button tables" data-game="tables" data-level="10">10 Times Table</button>
      </div>

      <div class="category-card">
        <div class="category-title">➖ Subtraction Practice</div>
        <button class="level-button subtraction" data-game="subtraction" data-level="50">Subtraction Practice</button>
      </div>

      <div class="category-card">
        <div class="category-title">⚡ Difficulty</div>
        <button id="diff-easy" class="level-button diff" data-difficulty="easy">Easy</button>
        <button id="diff-medium" class="level-button diff" data-difficulty="medium">Medium</button>
        <button id="diff-hard" class="level-button diff" data-difficulty="hard">Hard</button>
      </div>

      <div class="category-card">
        <div class="category-title">🏆 Leaderboard</div>
        <button class="level-button leaderboard-open" id="lb-open-btn">View Leaderboard</button>
        <div style="font-size:14px;color:#4a5568;margin-top:8px;text-align:center;">
          Shows top 10 per topic, level & difficulty.
        </div>
      </div>
    </div>
  </div>

  <div class="screen game-container" id="game-screen" role="main" aria-live="off">
    <div class="ui-panel">
      <div class="ui-left">
        <div class="score" id="score-wrap" aria-live="polite">Score: <span id="score">0</span></div>
        <div class="high-score" id="high-score">Best: 0</div>
        <span class="diff-pill" id="diff-label" title="Current difficulty">Medium</span>
        <div class="lives" id="lives" role="img" aria-label="Lives"></div>
      </div>

      <div>
        <div class="current-topic" id="current-topic">Addition up to 20</div>
        <div class="question-counter" id="q-wrap" aria-live="polite">Question: <span id="current-question">1</span>/10</div>
      </div>

      <div class="ui-right">
        <button class="lb-button" id="game-lb-btn">🏆</button>
        <button class="mute-button" id="mute-btn" aria-pressed="false">🔊</button>
        <button class="home-button" id="game-home-btn">🏠</button>
      </div>
    </div>

    <div class="timer-wrap" aria-hidden="true">
      <div class="timer-bar" id="timer-bar"></div>
    </div>

    <!-- Number pad stays at bottom -->
    <div class="number-pad" id="number-pad">
      <button class="num-btn" data-num="1">1</button>
      <button class="num-btn" data-num="2">2</button>
      <button class="num-btn" data-num="3">3</button>
      <button class="num-btn" data-num="4">4</button>
      <button class="num-btn" data-num="5">5</button>
      <button class="num-btn" data-num="6">6</button>
      <button class="num-btn" data-num="7">7</button>
      <button class="num-btn" data-num="8">8</button>
      <button class="num-btn" data-num="9">9</button>
      <button class="num-btn zero" data-num="0">0</button>
      <button class="num-btn clear" data-num="clear">Clear</button>
    </div>

    <div class="game-over-screen" id="game-over" aria-modal="true" role="dialog">
      <div class="game-over-content">
        <h2>Well Done! 🎉</h2>
        <div class="final-score">Final Score: <span id="final-score">0</span>/10</div>
        <div id="final-best" style="margin:6px 0 12px 0; font-weight:bold;"></div>
        <div id="performance-message" style="font-size: 20px; margin: 10px 0;"></div>

        <div class="name-wrap" id="save-area" style="display:none;">
          <input id="player-name" class="name-input" type="text" maxlength="20" placeholder="Your name or initials">
          <div class="hint">You made the top 10 for <span id="lb-context"></span> — save your score!</div>
          <div class="game-over-buttons" style="margin-top:10px;">
            <button class="save-btn" id="save-score-btn">💾 Save to Leaderboard</button>
          </div>
        </div>

        <div class="game-over-buttons">
          <button class="play-again-btn" id="play-again-btn">Play Again!</button>
          <button class="home-btn" id="gameover-home-btn">🏠 Home</button>
          <button class="lb-button" id="gameover-lb-btn">🏆 Leaderboard</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="leaderboard-modal" aria-modal="true" role="dialog">
    <div class="modal-card">
      <div class="modal-head">
        <div style="font-weight:800; font-size: 24px;">🏆 Leaderboard</div>
        <button class="close-btn" id="close-lb-btn">✖</button>
      </div>
      <div class="modal-body">
        <div class="filters">
          <span class="filter-pill">Difficulty:</span>
          <select id="lb-difficulty">
            <option value="easy">Easy</option>
            <option value="medium">Medium</option>
            <option value="hard">Hard</option>
          </select>

          <span class="filter-pill">Topic:</span>
          <select id="lb-topic">
            <option value="addition">Addition</option>
            <option value="tables">Times Tables</option>
            <option value="subtraction">Subtraction</option>
          </select>

          <span class="filter-pill">Level:</span>
          <select id="lb-level"></select>
        </div>

        <div id="lb-context-line" style="font-weight:700;margin: 6px 0 10px; font-size: 18px; color: var(--pink);"></div>

        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Player</th>
                <th>Score</th>
                <th>Time</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody id="lb-body">
              <tr><td colspan="5" class="empty">No scores yet — be the first!</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

      <script>
    console.log('[MathDrop] Script loading...');
    console.log('[MathDrop] User agent:', navigator.userAgent);

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() { 
        navigator.serviceWorker.register('./sw.js').catch(function(e) {
          console.log('[MathDrop] SW registration failed:', e);
        });
      });
    }

    let score = 0, currentQuestion = 1, gameActive = false, problems = [];
    let currentGameType = '', currentLevel = 0;
    let difficulty = localStorage.getItem('mathdrop_difficulty') || 'medium';
    let currentAnswer = ''; // Stores the current typed answer
    let currentProblemAnswer = 0; // Stores the correct answer for current problem
    
    const DIFF_SETTINGS = {
      easy: { lives: 5, timer: 15000, speedMul: 0.75, label: 'Easy' },
      medium: { lives: 3, timer: 10000, speedMul: 1.00, label: 'Medium' },
      hard: { lives: 2, timer: 7000, speedMul: 1.50, label: 'Hard' }
    };
    
    let diffSpeedMul = DIFF_SETTINGS[difficulty].speedMul;
    let lastFrameTime = 0, fallSpeedPxPerSec = 120;
    let QUESTION_TIME_MS = DIFF_SETTINGS[difficulty].timer;
    let questionStartMs = 0, roundStartMs = 0;
    let MAX_LIVES = DIFF_SETTINGS[difficulty].lives, lives = MAX_LIVES;
    let audioCtx = null, soundMuted = false, lastRoundTimeMs = 0;

    function initAudio() {
      if (!audioCtx) {
        try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
        catch(e){ audioCtx = null; }
      }
    }
    
    function playBeep(freq=880, durationMs=120, type='sine', gain=0.08) {
      if (soundMuted || !audioCtx) return;
      const osc = audioCtx.createOscillator(), g = audioCtx.createGain();
      osc.type = type; osc.frequency.value = freq; g.gain.value = gain;
      osc.connect(g).connect(audioCtx.destination);
      osc.start(); setTimeout(() => osc.stop(), durationMs);
    }
    
    function correctSfx(){ playBeep(880,120,'sine',0.09); setTimeout(()=>playBeep(1320,100,'sine',0.07),90); }
    function wrongSfx(){ playBeep(220,160,'square',0.09); }
    function missSfx(){ playBeep(180,180,'triangle',0.08); }

    function toggleMute(){
      soundMuted = !soundMuted;
      document.getElementById('mute-btn').textContent = soundMuted ? '🔇' : '🔊';
      if (!soundMuted) initAudio();
    }

    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function setDifficulty(level){
      console.log('[MathDrop] setDifficulty:', level);
      difficulty = level;
      localStorage.setItem('mathdrop_difficulty', level);
      applyDifficultyToState();
      updateDifficultyUI();
    }

    function applyDifficultyToState(){
      const cfg = DIFF_SETTINGS[difficulty];
      MAX_LIVES = cfg.lives; QUESTION_TIME_MS = cfg.timer; diffSpeedMul = cfg.speedMul;
      document.getElementById('diff-label').textContent = cfg.label;
      renderLivesHearts(MAX_LIVES); lives = MAX_LIVES; updateLivesUI();
    }

    function updateDifficultyUI(){
      ['easy','medium','hard'].forEach(lvl=>{
        const btn = document.getElementById('diff-' + lvl);
        if (btn) btn.classList.toggle('selected', lvl === difficulty);
      });
      document.getElementById('diff-label').textContent = DIFF_SETTINGS[difficulty].label;
    }

    function renderLivesHearts(count){
      document.getElementById('lives').innerHTML = Array.from({length:count}).map(()=>'<span class="heart">❤️</span>').join('');
    }

    function startGame(gameType, level) {
      console.log('[MathDrop] startGame:', gameType, level);
      currentGameType = gameType; currentLevel = level; score = 0; currentQuestion = 1;
      currentAnswer = ''; // Reset answer
      applyDifficultyToState(); updateDifficultyUI();
      problems.forEach(p => p.element.remove()); problems = [];

      let topicText = '';
      switch(gameType){
        case 'addition': topicText = `Addition up to ${level}`; break;
        case 'tables': topicText = `${level} Times Table`; break;
        case 'subtraction': topicText = 'Subtraction Practice'; break;
      }
      document.getElementById('current-topic').textContent = topicText;
      fallSpeedPxPerSec = getFallSpeed(gameType, level) * diffSpeedMul;

      document.getElementById('game-over').style.display = 'none';
      showScreen('game-screen'); updateUI(); updateHighScoreUI();
      lastFrameTime = performance.now(); startQuestionTimer(); roundStartMs = performance.now();
      gameActive = true; createProblemElement(); initAudio();
    }

    function getFallSpeed(type, level){
      if (type === 'tables') return 140 + (level * 6);
      if (type === 'addition') return 120 + Math.max(0, (level-20))*3;
      if (type === 'subtraction') return 140;
      return 120;
    }

    function generateProblem() {
      let num1, num2, answer, question;
      switch (currentGameType) {
        case 'addition': {
          const maxSum = currentLevel;
          num1 = Math.floor(Math.random() * (maxSum - 1)) + 1;
          num2 = Math.floor(Math.random() * (maxSum - num1)) + 1;
          answer = num1 + num2; question = `${num1} + ${num2} = ?`; break;
        }
        case 'tables': {
          num1 = currentLevel; num2 = Math.floor(Math.random() * 12) + 1;
          answer = num1 * num2; question = `${num1} × ${num2} = ?`; break;
        }
        case 'subtraction': {
          num1 = Math.floor(Math.random() * 40) + 10;
          num2 = Math.floor(Math.random() * num1) + 1;
          answer = num1 - num2; question = `${num1} - ${num2} = ?`; break;
        }
      }
      return { question, answer };
    }

    function createProblemElement() {
      if (!gameActive) return;
      const problem = generateProblem();
      currentProblemAnswer = problem.answer;
      currentAnswer = ''; // Reset current answer
      
      const div = document.createElement('div');
      div.className = 'math-problem';
      div.innerHTML = `<div>${problem.question}</div><div class="answer-display" id="answer-display"></div>`;
      div.style.left = Math.random() * (window.innerWidth - 260) + 'px';
      div.style.top = '90px';
      document.getElementById('game-screen').appendChild(div);
      problems.push({element: div, answer: problem.answer});
    }

    function updateAnswerDisplay() {
      const display = document.getElementById('answer-display');
      if (display) {
        display.textContent = currentAnswer || '';
      }
    }

    function handleNumberInput(num) {
      if (!gameActive || problems.length === 0) return;
      
      if (num === 'clear') {
        currentAnswer = '';
        updateAnswerDisplay();
        return;
      }
      
      // Limit to 3 digits
      if (currentAnswer.length >= 3) return;
      
      currentAnswer += num;
      updateAnswerDisplay();
      
      // Auto-submit logic
      const userAnswer = parseInt(currentAnswer, 10);
      const correctAnswer = currentProblemAnswer;
      
      // Determine expected digits
      const expectedDigits = String(correctAnswer).length;
      
      // Auto-submit when we have enough digits
      if (currentAnswer.length >= expectedDigits) {
        setTimeout(() => checkAnswer(), 200); // Small delay for visual feedback
      }
    }

    function checkAnswer() {
      if (!gameActive || problems.length === 0 || currentAnswer === '') return;
      
      const userAnswer = parseInt(currentAnswer, 10);
      const correctAnswer = currentProblemAnswer;
      const problemDiv = problems[0].element;

      if (userAnswer === correctAnswer) {
        score++; correctSfx();
        problemDiv.style.background = 'linear-gradient(145deg, #95E1D3 0%, #06D6A0 100%)';
        setTimeout(() => { removeProblem(problemDiv); advanceQuestion(); }, 300);
      } else {
        loseLife(); wrongSfx();
        problemDiv.style.background = 'linear-gradient(145deg, #F38181 0%, #E76B6B 100%)';
        setTimeout(() => { removeProblem(problemDiv); advanceQuestion(); }, 300);
      }
      updateUI();
    }

    function removeProblem(problemOrEl){
      const el = problemOrEl.element ? problemOrEl.element : problemOrEl;
      const idx = problems.findIndex(p => p.element === el);
      if (idx > -1) problems.splice(idx, 1);
      el.remove();
    }

    function advanceQuestion() {
      if (!gameActive) return;
      currentQuestion++;
      currentAnswer = '';
      if (currentQuestion <= 10 && lives > 0) {
        setTimeout(() => { startQuestionTimer(); createProblemElement(); updateUI(); }, 350);
      } else { endGame(); }
    }

    function startQuestionTimer(){
      questionStartMs = performance.now();
      document.getElementById('timer-bar').style.transform = 'scaleX(1)';
    }

    function checkTimer(now){
      if (!gameActive) return;
      const elapsed = now - questionStartMs;
      const remaining = Math.max(0, QUESTION_TIME_MS - elapsed);
      const pct = remaining / QUESTION_TIME_MS;
      document.getElementById('timer-bar').style.transform = `scaleX(${pct})`;
      if (remaining <= 0) {
        const current = problems[problems.length - 1];
        if (current) { missSfx(); loseLife(); removeProblem(current); }
        advanceQuestion();
      }
    }

    function updateLivesUI(){
      const livesEl = document.getElementById('lives');
      const hearts = livesEl.querySelectorAll('.heart');
      hearts.forEach((h, i) => h.classList.toggle('lost', i >= lives));
      livesEl.setAttribute('aria-label', `Lives: ${lives} of ${MAX_LIVES}`);
    }

    function loseLife(){
      lives = Math.max(0, lives - 1);
      updateLivesUI();
      if (lives <= 0) endGame();
    }

    function updateUI() {
      document.getElementById('score').textContent = String(score);
      document.getElementById('current-question').textContent = String(currentQuestion);
    }

    function highScoreKey(){ return `mathdrop_highscore_${currentGameType}_${currentLevel}`; }
    function getHighScore(){ const raw = localStorage.getItem(highScoreKey()); return raw ? parseInt(raw,10) : 0; }
    function setHighScoreIfBest(val){
      const best = getHighScore();
      if (val > best) { localStorage.setItem(highScoreKey(), String(val)); return val; }
      return best;
    }
    function updateHighScoreUI(){
      document.getElementById('high-score').textContent = `Best: ${getHighScore()}`;
    }

    function lbKey(topic, level, diff){ return `mathdrop_leaderboard_${topic}_${level}_${diff}`; }
    function loadLeaderboard(topic, level, diff){
      const raw = localStorage.getItem(lbKey(topic, level, diff));
      try { return raw ? JSON.parse(raw) : []; } catch { return []; }
    }
    function saveLeaderboard(topic, level, diff, arr){
      localStorage.setItem(lbKey(topic, level, diff), JSON.stringify(arr));
    }
    function qualifiesForLeaderboard(topic, level, diff, scoreVal, timeMs){
      const list = loadLeaderboard(topic, level, diff);
      if (list.length < 10) return true;
      list.sort(scoreSort);
      const worst = list[list.length - 1];
      return (scoreVal > worst.score) || (scoreVal === worst.score && timeMs < worst.timeMs);
    }
    function scoreSort(a, b){
      if (b.score !== a.score) return b.score - a.score;
      if (a.timeMs !== b.timeMs) return a.timeMs - b.timeMs;
      return (a.date || 0) - (b.date || 0);
    }

    function openLeaderboard(){
      const diffSel = document.getElementById('lb-difficulty');
      const topicSel = document.getElementById('lb-topic');
      const levelSel = document.getElementById('lb-level');
      diffSel.value = difficulty || 'medium';
      topicSel.value = currentGameType || 'addition';
      populateLevelOptions(topicSel.value, levelSel);
      levelSel.value = String(currentLevel || defaultLevelFor(topicSel.value));
      refreshLeaderboard();
      document.getElementById('leaderboard-modal').classList.add('active');
    }

    function closeLeaderboard(){
      document.getElementById('leaderboard-modal').classList.remove('active');
    }

    function onLbTopicChange(){
      const topicSel = document.getElementById('lb-topic');
      const levelSel = document.getElementById('lb-level');
      populateLevelOptions(topicSel.value, levelSel);
      levelSel.value = String(defaultLevelFor(topicSel.value));
      refreshLeaderboard();
    }

    function defaultLevelFor(topic){
      if (topic === 'addition') return 20;
      if (topic === 'tables') return 2;
      if (topic === 'subtraction') return 50;
      return 20;
    }

    function populateLevelOptions(topic, levelSelect){
      let options = [];
      if (topic === 'addition') options = [20,30,40,50];
      else if (topic === 'tables') options = [2,3,4,5,6,7,8,9,10];
      else options = [50];
      levelSelect.innerHTML = options.map(v => `<option value="${v}">${topic==='addition' ? 'Up to ' + v : (topic==='tables' ? (v + '× table') : v)}</option>`).join('');
    }

    function refreshLeaderboard(){
      const diffSel = document.getElementById('lb-difficulty');
      const topicSel = document.getElementById('lb-topic');
      const levelSel = document.getElementById('lb-level');
      const tbody = document.getElementById('lb-body');
      const contextLine = document.getElementById('lb-context-line');
      const diff = diffSel.value, topic = topicSel.value, level = parseInt(levelSel.value,10);
      const list = loadLeaderboard(topic, level, diff).sort(scoreSort).slice(0,10);
      const topicText = topic==='addition' ? `Addition ≤${level}` : topic==='tables' ? `${level}× table` : `Subtraction`;
      contextLine.textContent = `${topicText} — ${DIFF_SETTINGS[diff].label}`;
      if (!list.length){
        tbody.innerHTML = `<tr><td colspan="5" class="empty">No scores yet — be the first!</td></tr>`;
        return;
      }
      tbody.innerHTML = list.map((row, i) => {
        const date = new Date(row.date || Date.now());
        const dateStr = date.toLocaleDateString(undefined, { year:'2-digit', month:'short', day:'2-digit' });
        const timeStr = formatMs(row.timeMs);
        return `<tr><td>${i+1}</td><td>${escapeHtml(row.name || 'Player')}</td><td>${row.score}/10</td><td>${timeStr}</td><td>${dateStr}</td></tr>`;
      }).join('');
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }
    function formatMs(ms){
      const s = Math.floor(ms / 1000), m = Math.floor(s / 60), sec = s % 60;
      return (m ? (m + 'm ') : '') + sec + 's';
    }

    function endGame() {
      if (!gameActive) return;
      gameActive = false;
      const final = score, best = setHighScoreIfBest(final);
      document.getElementById('final-score').textContent = final;
      document.getElementById('final-best').textContent = best === final ? `🏆 New Best for this mode!` : `Best for this mode: ${best}`;
      let message = '';
      if (lives <= 0) message = "You're out of lives—great effort! Try again and beat your best!";
      else if (final === 10) message = "Perfect! You're a math superstar!";
      else if (final >= 8) message = "Excellent work! Keep it up!";
      else if (final >= 6) message = "Good job! Practice makes perfect!";
      else message = "Keep trying! You're getting better!";
      document.getElementById('performance-message').textContent = message;
      lastRoundTimeMs = Math.max(0, performance.now() - (roundStartMs || performance.now()));
      const ctxText = leaderboardContextText(currentGameType, currentLevel, difficulty);
      document.getElementById('lb-context').textContent = ctxText;
      if (qualifiesForLeaderboard(currentGameType, currentLevel, difficulty, final, lastRoundTimeMs)) {
        const prevName = localStorage.getItem('mathdrop_player_name') || '';
        document.getElementById('player-name').value = prevName;
        document.getElementById('save-area').style.display = 'block';
      } else {
        document.getElementById('save-area').style.display = 'none';
      }
      document.getElementById('game-over').style.display = 'flex';
      updateHighScoreUI();
    }

    function leaderboardContextText(topic, level, diff){
      const topicText = topic==='addition' ? `Addition ≤${level}` : topic==='tables' ? `${level}× table` : `Subtraction`;
      return `${topicText} — ${DIFF_SETTINGS[diff].label}`;
    }

    function saveLeaderboardEntry(){
      const name = (document.getElementById('player-name').value || 'Player').trim().slice(0,20);
      localStorage.setItem('mathdrop_player_name', name);
      const list = loadLeaderboard(currentGameType, currentLevel, difficulty);
      list.push({ name, score, timeMs: lastRoundTimeMs, date: Date.now() });
      const sorted = list.sort(scoreSort).slice(0,10);
      saveLeaderboard(currentGameType, currentLevel, difficulty, sorted);
      document.getElementById('save-area').style.display = 'none';
      openLeaderboard();
    }

    function playAgain() { startGame(currentGameType, currentLevel); }
    function goHome() {
      gameActive = false;
      problems.forEach(p => p.element.remove());
      problems = [];
      showScreen('home-screen');
    }

    function moveProblem(problemData, deltaMs) {
      const element = problemData.element;
      const currentTop = parseFloat(element.style.top) || 90;
      const deltaPx = (fallSpeedPxPerSec * deltaMs) / 1000;
      const newTop = currentTop + deltaPx;
      element.style.top = newTop + 'px';
      if (newTop > window.innerHeight - 200) { // Account for number pad
        removeProblem(element); missSfx(); loseLife(); advanceQuestion();
      }
    }

    function gameLoop(now = 0) {
      const deltaMs = Math.min(50, (now - lastFrameTime) || 16.7);
      lastFrameTime = now;
      if (gameActive) {
        for (let i = problems.length - 1; i >= 0; i--) moveProblem(problems[i], deltaMs);
        checkTimer(now);
      }
      requestAnimationFrame(gameLoop);
    }

    // Initialize and bind all events
    (function init(){
      updateDifficultyUI(); renderLivesHearts(MAX_LIVES); updateLivesUI();
      console.log('[MathDrop] Binding button event listeners...');
      
      // Number pad buttons - use mousedown for better iOS compatibility
      document.querySelectorAll('.num-btn').forEach(btn => {
        const num = btn.getAttribute('data-num');
        btn.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          handleNumberInput(num);
          return false;
        };
      });
      
      // Game start buttons
      document.querySelectorAll('button[data-game]').forEach(btn => {
        const gameType = btn.getAttribute('data-game');
        const level = parseInt(btn.getAttribute('data-level'), 10);
        btn.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('[MathDrop] Starting game:', gameType, level);
          startGame(gameType, level);
          return false;
        };
      });
      
      // Difficulty buttons
      document.querySelectorAll('button[data-difficulty]').forEach(btn => {
        const diff = btn.getAttribute('data-difficulty');
        btn.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          setDifficulty(diff);
          return false;
        };
      });
      
      // Leaderboard open buttons
      ['lb-open-btn', 'game-lb-btn', 'gameover-lb-btn'].forEach(id => {
        const btn = document.getElementById(id);
        if (btn) {
          btn.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            openLeaderboard();
            return false;
          };
        }
      });
      
      // Close leaderboard
      const closeLbBtn = document.getElementById('close-lb-btn');
      if (closeLbBtn) {
        closeLbBtn.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          closeLeaderboard();
          return false;
        };
      }
      
      // Home buttons
      ['game-home-btn', 'gameover-home-btn'].forEach(id => {
        const btn = document.getElementById(id);
        if (btn) {
          btn.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            goHome();
            return false;
          };
        }
      });
      
      // Play again button
      const playAgainBtn = document.getElementById('play-again-btn');
      if (playAgainBtn) {
        playAgainBtn.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          playAgain();
          return false;
        };
      }
      
      // Save score button
      const saveBtn = document.getElementById('save-score-btn');
      if (saveBtn) {
        saveBtn.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          saveLeaderboardEntry();
          return false;
        };
      }
      
      // Mute button
      const muteBtn = document.getElementById('mute-btn');
      if (muteBtn) {
        muteBtn.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          toggleMute();
          return false;
        };
      }
      
      // Leaderboard selects
      const lbDiff = document.getElementById('lb-difficulty');
      const lbTopic = document.getElementById('lb-topic');
      const lbLevel = document.getElementById('lb-level');
      if (lbDiff) lbDiff.onchange = refreshLeaderboard;
      if (lbTopic) lbTopic.onchange = onLbTopicChange;
      if (lbLevel) lbLevel.onchange = refreshLeaderboard;
      
      console.log('[MathDrop] All event listeners bound successfully!');
    })();

    requestAnimationFrame(gameLoop);
    console.log('[MathDrop] Script fully loaded and ready!');
  </script>
</body>
</html>
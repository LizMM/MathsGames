<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Math Drop Game</title>
  <style>
    :root{
      --ui-glass: rgba(255,255,255,0.95);
      --brand-1: #66cbea;
      --brand-2: #bc8cec;
      --good-1:#f33c8b;
      --good-2:#f33c8b;
      --bad-1:#c53030;
      --bad-2:#c53030;
      --blue-1:#4299e1;
      --blue-2:#3182ce;
      --amber-1:#f6ad55;
      --amber-2:#dd6b20;
    }


    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, var(--brand-1) 0%, var(--brand-2) 100%);
      font-family: 'Comic Sans MS', cursive, sans-serif;
      overflow: hidden;
      height: 100vh;
        }
    /* Screen visibility controller */
    .screen { 
      display: none;
    }
    .screen.active { 
      display: block;
      position: relative;      /* ensure positioned children behave */
      width: 100vw;            /* ensure full-viewport sizing */
      height: 100vh;
    }

    /* Home screen base styles */
    .home-screen {
      background: linear-gradient(135deg, var(--brand-1) 0%, var(--brand-2) 100%);
      padding: 20px;
    }

    /* Home screen layout only when active */
    .home-screen.active {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
}

    .game-title {
      font-size: 48px;
      font-weight: bold;
      color: white;
      text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
      margin-bottom: 20px;
      text-align: center;
    }
    .subhead {
      color: #fff;
      margin-bottom: 24px;
      opacity: 0.9;
      font-weight: bold;
    }
    .categories-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      max-width: 1200px;
      width: 100%;
      padding: 0 20px;
    }
    .category-card {
      background: rgba(255,255,255,0.95);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
    }
    .category-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 35px rgba(0,0,0,0.3);
    }
    .category-title {
      font-size: 24px;
      font-weight: bold;
      color: #4a5568;
      margin-bottom: 15px;
      text-align: center;
    }
    .level-button {
      display: block;
      width: 100%;
      background: linear-gradient(145deg, var(--good-1) 0%, var(--good-2) 100%);
      color: white;
      border: none;
      padding: 12px 20px;
      margin: 8px 0;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s ease;
      font-family: inherit;
    }
    .level-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .level-button.tables { background: linear-gradient(145deg, #ed8936 0%, #dd6b20 100%); }
    .level-button.subtraction { background: linear-gradient(145deg, #9f7aea 0%, #805ad5 100%); }
    .level-button.diff { background: linear-gradient(145deg, var(--amber-1) 0%, var(--amber-2) 100%); }
    .level-button.selected { outline: 3px solid #fff; box-shadow: 0 0 0 3px rgba(0,0,0,0.12) inset; }

    .leaderboard-open {
      background: linear-gradient(145deg, #805ad5 0%, #6b46c1 100%);
    }

    /* Game */
    .game-container {
      position: relative; width: 100vw; height: 100vh;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="white" opacity="0.3"/><circle cx="80" cy="40" r="1.5" fill="white" opacity="0.2"/><circle cx="40" cy="60" r="1" fill="white" opacity="0.4"/><circle cx="70" cy="80" r="2.5" fill="white" opacity="0.2"/></svg>');
    }
    .ui-panel {
      position: fixed; top: 0; left: 0; right: 0;
      background: var(--ui-glass);
      padding: 12px 15px;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 1000;
    }
    .ui-left { display:flex; align-items:center; gap:16px; flex-wrap: wrap; }
    .score { font-size: 22px; font-weight: bold; color: #4a5568; }
    .high-score { font-size: 16px; color: #718096; }
    .diff-pill {
      padding: 4px 10px; border-radius: 999px; background: #edf2f7; color: #2d3748;
      font-size: 14px; font-weight: 700; border: 1px solid #e2e8f0;
    }
    .question-counter { font-size: 20px; color: #718096; text-align:center; }
    .ui-right { display:flex; gap:8px; align-items:center; justify-content:flex-end; }
    .home-button, .mute-button, .lb-button {
      background: linear-gradient(145deg, var(--blue-1) 0%, var(--blue-2) 100%);
      color: white; border: none; padding: 9px 16px; border-radius: 8px;
      cursor: pointer; font-weight: bold; font-family: inherit;
    }
    .current-topic { font-size: 18px; color: #4a5568; font-weight: bold; text-align:center; }

    .lives { display:flex; align-items:center; gap:6px; margin-left: 6px; font-size: 22px; }
    .heart { filter: drop-shadow(0 2px 2px rgba(0,0,0,0.15)); }
    .heart.lost { opacity: 0.2; }

    .timer-wrap {
      position: fixed; top: 64px; left: 50%; transform: translateX(-50%);
      width: min(720px, 90vw); height: 10px; background: rgba(255,255,255,0.5);
      border-radius: 999px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 999;
    }
    .timer-bar { height: 100%; width: 100%; background: linear-gradient(90deg, var(--good-1), #f6e05e, #f56565); transform-origin: left center; }

    .math-problem {
      position: absolute;
      background: linear-gradient(145deg, #ffd89b 0%, #19547b 100%);
      color: white; padding: 20px; border-radius: 15px;
      font-size: 24px; font-weight: bold;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      cursor: pointer; transition: all 0.2s ease;
      min-width: 220px; text-align: center;
      border: 3px solid #fff; z-index: 10;
    }
    .math-problem:hover { transform: scale(1.05); box-shadow: 0 12px 25px rgba(0,0,0,0.4); }

    .answer-input {
      background: white; border: 3px solid var(--blue-1); border-radius: 10px;
      padding: 10px; font-size: 20px; text-align: center; margin-top: 10px;
      width: 90px; font-weight: bold;
    }
    .answer-input:focus { outline: none; border-color: var(--blue-2); box-shadow: 0 0 10px rgba(66,153,225,0.5); }

    .game-over-screen {
      position: fixed; inset: 0; background: rgba(0,0,0,0.8);
      display: none; justify-content: center; align-items: center; z-index: 2000;
    }
    .game-over-content {
      background: linear-gradient(145deg, var(--brand-1) 0%, var(--brand-2) 100%);
      color: white; padding: 40px; border-radius: 20px; text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5); max-width: 90vw;
    }
    .game-over-content h2 { margin-top: 0; font-size: 36px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
    .final-score { font-size: 28px; margin: 12px 0; }
    .game-over-buttons { display:flex; gap:15px; justify-content:center; margin-top:16px; flex-wrap: wrap; }
    .play-again-btn, .home-btn {
      background: linear-gradient(145deg, var(--good-1) 0%, var(--good-2) 100%);
      color: white; border:none; padding: 12px 20px; font-size: 18px; border-radius: 10px;
      cursor: pointer; font-weight: bold; transition: all 0.2s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      font-family: inherit;
    }
    .home-btn { background: linear-gradient(145deg, var(--blue-1) 0%, var(--blue-2) 100%); }
    .save-btn { background: linear-gradient(145deg, #38b2ac 0%, #319795 100%); color:#fff; border:none; padding: 12px 20px; font-size: 18px; border-radius: 10px; cursor: pointer; font-weight: bold;}
    .play-again-btn:hover, .home-btn:hover, .save-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }

    .name-wrap { margin-top: 10px; }
    .name-input {
      padding: 8px 10px; border-radius: 8px; border: none; width: 220px; font-size: 16px;
      box-shadow: 0 0 0 3px rgba(255,255,255,0.3) inset;
    }
    .hint { font-size: 14px; opacity: 0.9; margin-top: 6px; }

    /* Leaderboard modal */
    .modal {
      position: fixed; inset: 0; display:none; align-items: center; justify-content:center; background: rgba(0,0,0,0.65); z-index: 2500;
    }
    .modal.active { display:flex; }
    .modal-card {
      background: #ffffff;
      color:#2d3748;
      width: min(860px, 92vw);
      border-radius: 16px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.35);
      overflow: hidden;
    }
    .modal-head {
      display:flex; justify-content: space-between; align-items:center;
      padding: 12px 16px; background: linear-gradient(145deg, var(--brand-1), var(--brand-2)); color:#fff;
    }
    .modal-body { padding: 16px; background: #f7fafc; }
    .close-btn { background: transparent; color:#fff; border:none; font-size: 22px; cursor: pointer; }
    .filters { display:flex; gap: 8px; flex-wrap: wrap; align-items:center; margin-bottom: 12px; }
    select, .filter-pill {
      padding: 6px 10px; border-radius: 8px; border: 1px solid #e2e8f0; background:#fff; font-weight:600;
    }
    .filter-pill { background:#edf2f7; }
    table { width:100%; border-collapse: collapse; background: #fff; border-radius: 10px; overflow: hidden; }
    th, td { padding: 10px 12px; border-bottom: 1px solid #edf2f7; text-align:left; }
    thead tr { background: var(--table-head); }
    tbody tr:nth-child(even){ background:#fbfdff; }
    .empty { padding: 20px; text-align:center; color:#718096; font-weight:600; }

    @media (max-width: 768px) {
      .game-title { font-size: 36px; }
      .categories-grid { grid-template-columns: 1fr; max-width: 400px; }
    }
  </style>
</head>
<body>

    body[data-started] {
    outline: 4px solid rgba(72,187,120,0.7);
    outline-offset: -4px;
    } 

  <!-- Home Screen -->
  <div class="screen active home-screen" id="home-screen">
    <div class="game-title">üéØ Math Drop Challenge! üéØ</div>
    <div class="subhead">Pick a topic, set difficulty, and try to make the leaderboard!</div>

    <div class="categories-grid">
      <div class="category-card">
        <div class="category-title">‚ûï Addition Practice</div>
        <button class="level-button" onclick="startGame('addition', 20)">Addition up to 20</button>
        <button class="level-button" onclick="startGame('addition', 30)">Addition up to 30</button>
        <button class="level-button" onclick="startGame('addition', 40)">Addition up to 40</button>
        <button class="level-button" onclick="startGame('addition', 50)">Addition up to 50</button>
      </div>

      <div class="category-card">
        <div class="category-title">‚úñÔ∏è Times Tables</div>
        <button class="level-button tables" onclick="startGame('tables', 2)">2 Times Table</button>
        <button class="level-button tables" onclick="startGame('tables', 3)">3 Times Table</button>
        <button class="level-button tables" onclick="startGame('tables', 4)">4 Times Table</button>
        <button class="level-button tables" onclick="startGame('tables', 5)">5 Times Table</button>
      </div>

      <div class="category-card">
        <div class="category-title">‚úñÔ∏è More Times Tables</div>
        <button class="level-button tables" onclick="startGame('tables', 6)">6 Times Table</button>
        <button class="level-button tables" onclick="startGame('tables', 7)">7 Times Table</button>
        <button class="level-button tables" onclick="startGame('tables', 8)">8 Times Table</button>
        <button class="level-button tables" onclick="startGame('tables', 9)">9 Times Table</button>
        <button class="level-button tables" onclick="startGame('tables', 10)">10 Times Table</button>
      </div>

      <div class="category-card">
        <div class="category-title">‚ûñ Subtraction Practice</div>
        <button class="level-button subtraction" onclick="startGame('subtraction', 50)">Subtraction Practice</button>
      </div>

      <!-- Difficulty Card -->
      <div class="category-card">
        <div class="category-title">‚ö° Difficulty</div>
        <button id="diff-easy" class="level-button diff" onclick="setDifficulty('easy')">Easy</button>
        <button id="diff-medium" class="level-button diff" onclick="setDifficulty('medium')">Medium</button>
        <button id="diff-hard" class="level-button diff" onclick="setDifficulty('hard')">Hard</button>
      </div>

      <!-- Leaderboard Card -->
      <div class="category-card">
        <div class="category-title">üèÜ Leaderboard</div>
        <button class="level-button leaderboard-open" onclick="openLeaderboard()">View Leaderboard</button>
        <div style="font-size:14px;color:#4a5568;margin-top:8px;text-align:center;">
          Shows top 10 per topic, level & difficulty.
        </div>
      </div>
    </div>
  </div>

  <!-- Game Screen -->
  <div class="screen game-container" id="game-screen" role="main" aria-live="off">
    <div class="ui-panel">
      <div class="ui-left">
        <div class="score" id="score-wrap" aria-live="polite">Score: <span id="score">0</span></div>
        <div class="high-score" id="high-score">Best: 0</div>
        <span class="diff-pill" id="diff-label" title="Current difficulty">Medium</span>
        <div class="lives" id="lives" role="img" aria-label="Lives"></div>
      </div>

      <div>
        <div class="current-topic" id="current-topic">Addition up to 20</div>
        <div class="question-counter" id="q-wrap" aria-live="polite">Question: <span id="current-question">1</span>/10</div>
      </div>

      <div class="ui-right">
        <button class="lb-button" onclick="openLeaderboard()">üèÜ Leaderboard</button>
        <button class="mute-button" id="mute-btn" onclick="toggleMute()" aria-pressed="false">üîä Sound</button>
        <button class="home-button" onclick="goHome()">üè† Home</button>
      </div>
    </div>

    <div class="timer-wrap" aria-hidden="true">
      <div class="timer-bar" id="timer-bar"></div>
    </div>

    <div class="game-over-screen" id="game-over" aria-modal="true" role="dialog">
      <div class="game-over-content">
        <h2>Well Done! üéâ</h2>
        <div class="final-score">Final Score: <span id="final-score">0</span>/10</div>
        <div id="final-best" style="margin:6px 0 12px 0; font-weight:bold;"></div>
        <div id="performance-message"></div>

        <!-- Save to leaderboard area (shown conditionally) -->
        <div class="name-wrap" id="save-area" style="display:none;">
          <input id="player-name" class="name-input" type="text" maxlength="20" placeholder="Your name or initials">
          <div class="hint">You made the top 10 for <span id="lb-context"></span> ‚Äî save your score!</div>
          <div class="game-over-buttons" style="margin-top:10px;">
            <button class="save-btn" onclick="saveLeaderboardEntry()">üíæ Save to Leaderboard</button>
          </div>
        </div>

        <div class="game-over-buttons">
          <button class="play-again-btn" onclick="playAgain()">Play Again!</button>
          <button class="home-btn" onclick="goHome()">üè† Home</button>
          <button class="lb-button" onclick="openLeaderboard()">üèÜ View Leaderboard</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Leaderboard Modal -->
  <div class="modal" id="leaderboard-modal" aria-modal="true" role="dialog">
    <div class="modal-card">
      <div class="modal-head">
        <div style="font-weight:800;">üèÜ Leaderboard</div>
        <button class="close-btn" onclick="closeLeaderboard()">‚úñ</button>
      </div>
      <div class="modal-body">
        <div class="filters">
          <span class="filter-pill">Difficulty:</span>
          <select id="lb-difficulty" onchange="refreshLeaderboard()">
            <option value="easy">Easy</option>
            <option value="medium">Medium</option>
            <option value="hard">Hard</option>
          </select>

          <span class="filter-pill">Topic:</span>
          <select id="lb-topic" onchange="onLbTopicChange()">
            <option value="addition">Addition</option>
            <option value="tables">Times Tables</option>
            <option value="subtraction">Subtraction</option>
          </select>

          <span class="filter-pill">Level:</span>
          <select id="lb-level" onchange="refreshLeaderboard()">
            <!-- filled dynamically -->
          </select>
        </div>

        <div id="lb-context-line" style="font-weight:700;margin: 6px 0 10px;"></div>

        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Player</th>
                <th>Score</th>
                <th>Time</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody id="lb-body">
              <tr><td colspan="5" class="empty">No scores yet ‚Äî be the first!</td></tr>
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>

  <script>
  
    if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
  }

    // --- Game State ---
    let score = 0;
    let currentQuestion = 1;
    let gameActive = false;
    let problems = [];
    let currentGameType = '';
    let currentLevel = 0;

    // Difficulty (persisted)
    let difficulty = localStorage.getItem('mathdrop_difficulty') || 'medium';
    const DIFF_SETTINGS = {
      easy:   { lives: 5, timer: 15000, speedMul: 0.75, label: 'Easy' },
      medium: { lives: 3, timer: 10000, speedMul: 1.00, label: 'Medium' },
      hard:   { lives: 2, timer:  7000, speedMul: 1.50, label: 'Hard' }
    };
    let diffSpeedMul = DIFF_SETTINGS[difficulty].speedMul;

    // Falling & timing
    let lastFrameTime = 0;                 // ms
    let fallSpeedPxPerSec = 120;           // base; will scale by mode/level * difficulty
    let QUESTION_TIME_MS = DIFF_SETTINGS[difficulty].timer;
    let questionStartMs = 0;

    // Round timing (for leaderboard tiebreak)
    let roundStartMs = 0;

    // Lives (dynamic per difficulty)
    let MAX_LIVES = DIFF_SETTINGS[difficulty].lives;
    let lives = MAX_LIVES;

    // Sound
    let audioCtx = null;
    let soundMuted = false;

    // --- Audio helpers ---
    function initAudio() {
      if (!audioCtx) {
        try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
        catch(e){ audioCtx = null; }
      }
    }
    function playBeep(freq=880, durationMs=120, type='sine', gain=0.08) {
      if (soundMuted || !audioCtx) return;
      const osc = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      osc.type = type;
      osc.frequency.value = freq;
      g.gain.value = gain;
      osc.connect(g).connect(audioCtx.destination);
      osc.start();
      setTimeout(() => { osc.stop(); }, durationMs);
    }
    function correctSfx(){ playBeep(880,120,'sine',0.09); setTimeout(()=>playBeep(1320,100,'sine',0.07),90); }
    function wrongSfx(){ playBeep(220,160,'square',0.09); }
    function missSfx(){ playBeep(180,180,'triangle',0.08); }

    function toggleMute(){
      soundMuted = !soundMuted;
      const btn = document.getElementById('mute-btn');
      btn.textContent = soundMuted ? 'üîá Muted' : 'üîä Sound';
      btn.setAttribute('aria-pressed', String(!soundMuted));
      if (!soundMuted) initAudio(); // lazy init
    }

    // --- UI switching ---
    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
    }

    // --- Difficulty UI / Apply ---
    function setDifficulty(level){
      difficulty = level;
      localStorage.setItem('mathdrop_difficulty', level);
      applyDifficultyToState();
      updateDifficultyUI();
    }

    function applyDifficultyToState(){
      const cfg = DIFF_SETTINGS[difficulty];
      MAX_LIVES = cfg.lives;
      QUESTION_TIME_MS = cfg.timer;
      diffSpeedMul = cfg.speedMul;
      document.getElementById('diff-label').textContent = cfg.label;
      renderLivesHearts(MAX_LIVES);
      lives = MAX_LIVES;
      updateLivesUI();
    }

    function updateDifficultyUI(){
      ['easy','medium','hard'].forEach(lvl=>{
        const btn = document.getElementById('diff-' + lvl);
        if (!btn) return;
        btn.classList.toggle('selected', lvl === difficulty);
      });
      document.getElementById('diff-label').textContent = DIFF_SETTINGS[difficulty].label;
    }

    function renderLivesHearts(count){
      const livesEl = document.getElementById('lives');
      livesEl.innerHTML = Array.from({length: count}).map(()=>'<span class="heart">‚ù§Ô∏è</span>').join('');
    }

    // --- Start Game ---
    function startGame(gameType, level) {
      console.log('startGame called with:', gameType, level);
      document.body.setAttribute('data-started', Date.now()); // visual breadcrumb
      currentGameType = gameType;
      currentLevel = level;
      score = 0;
      currentQuestion = 1;

      applyDifficultyToState();
      updateDifficultyUI();

      // Clear problems
      problems.forEach(p => p.element.remove());
      problems = [];

      // Topic text
      let topicText = '';
      switch(gameType){
        case 'addition': topicText = `Addition up to ${level}`; break;
        case 'tables': topicText = `${level} Times Table`; break;
        case 'subtraction': topicText = 'Subtraction Practice'; break;
      }
      document.getElementById('current-topic').textContent = topicText;

      // Difficulty-aware fall speed
      fallSpeedPxPerSec = getFallSpeed(gameType, level) * diffSpeedMul;

      document.getElementById('game-over').style.display = 'none';
      showScreen('game-screen');
      updateUI();
      updateHighScoreUI();

      // reset timers
      lastFrameTime = performance.now();
      startQuestionTimer();
      roundStartMs = performance.now();

      gameActive = true;
      createProblemElement();
      initAudio();
    }

    function getFallSpeed(type, level){
      if (type === 'tables') return 140 + (level * 6);
      if (type === 'addition') return 120 + Math.max(0, (level-20))*3;
      if (type === 'subtraction') return 140;
      return 120;
    }

    // --- Problem Generation ---
    function generateProblem() {
      let num1, num2, answer, question;

      switch (currentGameType) {
        case 'addition': {
          const maxSum = currentLevel;
          num1 = Math.floor(Math.random() * (maxSum - 1)) + 1;  // 1..(maxSum-1)
          const maxAdd2 = maxSum - num1;
          num2 = Math.floor(Math.random() * maxAdd2) + 1;       // 1..(maxSum - num1)
          answer = num1 + num2;
          question = `${num1} + ${num2} = ?`;
          break;
        }
        case 'tables': {
          num1 = currentLevel;
          num2 = Math.floor(Math.random() * 12) + 1;            // 1..12
          answer = num1 * num2;
          question = `${num1} √ó ${num2} = ?`;
          break;
        }
        case 'subtraction': {
          num1 = Math.floor(Math.random() * 40) + 10;           // 10..49
          num2 = Math.floor(Math.random() * num1) + 1;          // 1..num1
          answer = num1 - num2;
          question = `${num1} - ${num2} = ?`;
          break;
        }
      }
      return { question, answer };
    }

    function createProblemElement() {
      if (!gameActive) return;

      const problem = generateProblem();
      const problemDiv = document.createElement('div');
      problemDiv.className = 'math-problem';
      problemDiv.innerHTML = `
        <div>${problem.question}</div>
        <input type="text" inputmode="numeric" pattern="[0-9]*"
          class="answer-input" placeholder="?"
          onkeydown="handleAnswer(event, this, ${problem.answer})"
          aria-label="Your answer">
      `;

      problemDiv.style.left = Math.random() * (window.innerWidth - 260) + 'px';
      problemDiv.style.top = '90px';

      document.getElementById('game-screen').appendChild(problemDiv);
      problems.push({element: problemDiv, answer: problem.answer});

      setTimeout(() => {
        const input = problemDiv.querySelector('.answer-input');
        input && input.focus({ preventScroll: true });
      }, 0);
    }

    // --- Answers ---
    function handleAnswer(event, input, correctAnswer) {
      if (event.key !== 'Enter') return;
      event.preventDefault();

      const val = input.value.trim();
      if (val === '') { input.focus(); return; }

      const userAnswer = Number(val);
      if (!Number.isFinite(userAnswer)) { input.focus(); input.select(); return; }

      const problemDiv = input.closest('.math-problem');

      if (userAnswer === correctAnswer) {
        score++;
        correctSfx();
        problemDiv.classList.add('correct-animation');
        setTimeout(() => {
          removeProblem(problemDiv);
          advanceQuestion();
        }, 520);
      } else {
        loseLife();
        wrongSfx();
        problemDiv.classList.add('wrong-animation');
        setTimeout(() => {
          removeProblem(problemDiv);
          advanceQuestion();
        }, 520);
      }
      updateUI();
    }

    // --- Remove Problem (safe) ---
    function removeProblem(problemOrEl){
      const el = problemOrEl.element ? problemOrEl.element : problemOrEl;
      const idx = problems.findIndex(p => p.element === el);
      if (idx > -1) problems.splice(idx, 1);
      el.remove();
    }

    // --- Question flow & timer ---
    function advanceQuestion() {
      if (!gameActive) return;
      currentQuestion++;
      if (currentQuestion <= 10 && lives > 0) {
        setTimeout(() => {
          startQuestionTimer();
          createProblemElement();
          updateUI();
        }, 350);
      } else {
        endGame();
      }
    }

    function startQuestionTimer(){
      questionStartMs = performance.now();
      const bar = document.getElementById('timer-bar');
      bar.style.transform = 'scaleX(1)';
    }

    function checkTimer(now){
      if (!gameActive) return;
      const elapsed = now - questionStartMs;
      const remaining = Math.max(0, QUESTION_TIME_MS - elapsed);
      const pct = remaining / QUESTION_TIME_MS;
      const bar = document.getElementById('timer-bar');
      bar.style.transform = `scaleX(${pct})`;
      if (remaining <= 0) {
        const current = problems[problems.length - 1];
        if (current) {
          missSfx();
          loseLife();
          removeProblem(current);
        }
        advanceQuestion();
      }
    }

    // --- Lives ---
    function updateLivesUI(){
      const livesEl = document.getElementById('lives');
      const hearts = livesEl.querySelectorAll('.heart');
      hearts.forEach((h, i) => { h.classList.toggle('lost', i >= lives); });
      livesEl.setAttribute('aria-label', `Lives: ${lives} of ${MAX_LIVES}`);
    }

    function loseLife(){
      lives = Math.max(0, lives - 1);
      updateLivesUI();
      if (lives <= 0) endGame();
    }

    // --- UI + High Score ---
    function updateUI() {
      document.getElementById('score').textContent = String(score);
      document.getElementById('current-question').textContent = String(currentQuestion);
    }

    function highScoreKey(){ return `mathdrop_highscore_${currentGameType}_${currentLevel}`; }
    function getHighScore(){ const raw = localStorage.getItem(highScoreKey()); return raw ? parseInt(raw,10) : 0; }
    function setHighScoreIfBest(val){
      const best = getHighScore();
      if (val > best) { localStorage.setItem(highScoreKey(), String(val)); return val; }
      return best;
    }
    function updateHighScoreUI(){
      const best = getHighScore();
      document.getElementById('high-score').textContent = `Best: ${best}`;
    }

    // --- Leaderboard (per topic, level, difficulty) ---
    function lbKey(topic, level, diff){
      return `mathdrop_leaderboard_${topic}_${level}_${diff}`;
    }

    function loadLeaderboard(topic, level, diff){
      const raw = localStorage.getItem(lbKey(topic, level, diff));
      try { return raw ? JSON.parse(raw) : []; } catch { return []; }
    }

    function saveLeaderboard(topic, level, diff, arr){
      localStorage.setItem(lbKey(topic, level, diff), JSON.stringify(arr));
    }

    // returns true if this (score,time) qualifies for top 10
    function qualifiesForLeaderboard(topic, level, diff, scoreVal, timeMs){
      const list = loadLeaderboard(topic, level, diff);
      if (list.length < 10) return true;
      list.sort(scoreSort);
      const worst = list[list.length - 1];
      // better if higher score OR equal score but faster time
      return (scoreVal > worst.score) || (scoreVal === worst.score && timeMs < worst.timeMs);
    }

    function scoreSort(a, b){
      if (b.score !== a.score) return b.score - a.score; // higher score first
      if (a.timeMs !== b.timeMs) return a.timeMs - b.timeMs; // faster first
      return (a.date || 0) - (b.date || 0); // older first
    }

    function openLeaderboard(){
      // Set filters to current context by default
      const diffSel = document.getElementById('lb-difficulty');
      const topicSel = document.getElementById('lb-topic');
      const levelSel = document.getElementById('lb-level');

      diffSel.value = difficulty || 'medium';
      topicSel.value = currentGameType || 'addition';

      populateLevelOptions(topicSel.value, levelSel);
      levelSel.value = String(currentLevel || defaultLevelFor(topicSel.value));

      refreshLeaderboard();
      document.getElementById('leaderboard-modal').classList.add('active');
    }

    function closeLeaderboard(){
      document.getElementById('leaderboard-modal').classList.remove('active');
    }

    function onLbTopicChange(){
      const topicSel = document.getElementById('lb-topic');
      const levelSel = document.getElementById('lb-level');
      populateLevelOptions(topicSel.value, levelSel);
      levelSel.value = String(defaultLevelFor(topicSel.value));
      refreshLeaderboard();
    }

    function defaultLevelFor(topic){
      if (topic === 'addition') return 20;
      if (topic === 'tables') return 2;
      if (topic === 'subtraction') return 50;
      return 20;
    }

    function populateLevelOptions(topic, levelSelect){
      let options = [];
      if (topic === 'addition'){
        options = [20,30,40,50];
      } else if (topic === 'tables'){
        options = [2,3,4,5,6,7,8,9,10];
      } else {
        options = [50];
      }
      levelSelect.innerHTML = options.map(v => `<option value="${v}">${topic==='addition' ? 'Up to ' + v : (topic==='tables' ? (v + '√ó table') : v)}</option>`).join('');
    }

    function refreshLeaderboard(){
      const diffSel = document.getElementById('lb-difficulty');
      const topicSel = document.getElementById('lb-topic');
      const levelSel = document.getElementById('lb-level');
      const tbody = document.getElementById('lb-body');
      const contextLine = document.getElementById('lb-context-line');

      const diff = diffSel.value;
      const topic = topicSel.value;
      const level = parseInt(levelSel.value,10);

      const list = loadLeaderboard(topic, level, diff).sort(scoreSort).slice(0,10);

      const topicText = topic==='addition' ? `Addition ‚â§${level}` :
                        topic==='tables'   ? `${level}√ó table` :
                                             `Subtraction`;
      contextLine.textContent = `${topicText} ‚Äî ${DIFF_SETTINGS[diff].label}`;

      if (!list.length){
        tbody.innerHTML = `<tr><td colspan="5" class="empty">No scores yet ‚Äî be the first!</td></tr>`;
        return;
      }

      tbody.innerHTML = list.map((row, i) => {
        const date = new Date(row.date || Date.now());
        const dateStr = date.toLocaleDateString(undefined, { year:'2-digit', month:'short', day:'2-digit' });
        const timeStr = formatMs(row.timeMs);
        return `<tr>
          <td>${i+1}</td>
          <td>${escapeHtml(row.name || 'Player')}</td>
          <td>${row.score}/10</td>
          <td>${timeStr}</td>
          <td>${dateStr}</td>
        </tr>`;
      }).join('');
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }

    function formatMs(ms){
      const s = Math.floor(ms / 1000);
      const m = Math.floor(s / 60);
      const sec = s % 60;
      return (m ? (m + 'm ') : '') + sec + 's';
    }

    // --- Save flow at Game Over ---
    let lastRoundTimeMs = 0;

    function endGame() {
      if (!gameActive) return;
      gameActive = false;

      const final = score;
      const best = setHighScoreIfBest(final);
      document.getElementById('final-score').textContent = final;
      document.getElementById('final-best').textContent = best === final
        ? `üèÜ New Best for this mode!`
        : `Best for this mode: ${best}`;

      let message = '';
      if (lives <= 0) {
        message = "You're out of lives‚Äîgreat effort! Try again and beat your best! üí™";
      } else if (final === 10) {
        message = "Perfect! You're a math superstar! ‚≠ê";
      } else if (final >= 8) {
        message = "Excellent work! Keep it up! üåü";
      } else if (final >= 6) {
        message = "Good job! Practice makes perfect! üëç";
      } else {
        message = "Keep trying! You're getting better! üí™";
      }
      document.getElementById('performance-message').textContent = message;

      // Compute round time
      lastRoundTimeMs = Math.max(0, performance.now() - (roundStartMs || performance.now()));

      // Leaderboard qualification?
      const ctxText = leaderboardContextText(currentGameType, currentLevel, difficulty);
      document.getElementById('lb-context').textContent = ctxText;

      if (qualifiesForLeaderboard(currentGameType, currentLevel, difficulty, final, lastRoundTimeMs)) {
        const prevName = localStorage.getItem('mathdrop_player_name') || '';
        const input = document.getElementById('player-name');
        input.value = prevName;
        document.getElementById('save-area').style.display = 'block';
      } else {
        document.getElementById('save-area').style.display = 'none';
      }

      document.getElementById('game-over').style.display = 'flex';
      updateHighScoreUI();
    }

    function leaderboardContextText(topic, level, diff){
      const topicText = topic==='addition' ? `Addition ‚â§${level}` :
                        topic==='tables'   ? `${level}√ó table` :
                                             `Subtraction`;
      return `${topicText} ‚Äî ${DIFF_SETTINGS[diff].label}`;
    }

    function saveLeaderboardEntry(){
      const name = (document.getElementById('player-name').value || 'Player').trim().slice(0,20);
      localStorage.setItem('mathdrop_player_name', name);

      const topic = currentGameType;
      const level = currentLevel;
      const diff = difficulty;

      const list = loadLeaderboard(topic, level, diff);
      list.push({
        name,
        score,
        timeMs: lastRoundTimeMs,
        date: Date.now()
      });
      const sorted = list.sort(scoreSort).slice(0,10);
      saveLeaderboard(topic, level, diff, sorted);

      // Hide save area, open modal to show standings
      document.getElementById('save-area').style.display = 'none';
      openLeaderboard();
    }

    // --- End / Restart / Home ---
    function playAgain() { startGame(currentGameType, currentLevel); }

    function goHome() {
      gameActive = false;
      problems.forEach(p => p.element.remove());
      problems = [];
      showScreen('home-screen');
    }

    // --- Movement (frame-rate independent) ---
    function moveProblem(problemData, deltaMs) {
      const element = problemData.element;
      const currentTop = parseFloat(element.style.top) || 90;
      const deltaPx = (fallSpeedPxPerSec * deltaMs) / 1000;
      const newTop = currentTop + deltaPx;

      element.style.top = newTop + 'px';

      if (newTop > window.innerHeight - 110) {
        removeProblem(element);
        missSfx();
        loseLife();
        advanceQuestion();
      }
    }

    // --- Game loop (safe iteration) ---
    function gameLoop(now = 0) {
      const deltaMs = Math.min(50, (now - lastFrameTime) || 16.7);
      lastFrameTime = now;

      if (gameActive) {
        for (let i = problems.length - 1; i >= 0; i--) {
          moveProblem(problems[i], deltaMs);
        }
        checkTimer(now);
      }
      requestAnimationFrame(gameLoop);
    }
    requestAnimationFrame(gameLoop);

    // Accessibility: prevent page scroll on Enter in inputs
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const active = document.activeElement;
        if (active && active.classList && active.classList.contains('answer-input')) {
          e.preventDefault();
        }
      }
    });

    // Init difficulty UI and lives on load (for Home)
    (function init(){
      updateDifficultyUI();
      renderLivesHearts(MAX_LIVES);
      updateLivesUI();
    })();

  // Expose functions used by inline onclick/onkeydown handlers
  window.startGame     = startGame;
  window.goHome        = goHome;
  window.playAgain     = playAgain;
  window.toggleMute    = toggleMute;
  window.handleAnswer  = handleAnswer;

  // If you have these, expose them too:
  if (typeof openLeaderboard !== 'undefined')  window.openLeaderboard  = openLeaderboard;
  if (typeof closeLeaderboard !== 'undefined') window.closeLeaderboard = closeLeaderboard;
  if (typeof setDifficulty !== 'undefined')    window.setDifficulty    = setDifficulty;

  // Prevent Enter key from scrolling the page
  window.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    const a = document.activeElement;
    if (a && a.classList && a.classList.contains('answer-input')) {
      e.preventDefault();
    }
    }
    });

  </script>
</body>
</html>
